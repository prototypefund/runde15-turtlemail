include:
  - project: "kmohrf/gitlabfilet"
    ref: "v1.4.0"
    file:
      - "/templates/python.gitlab-ci.yml"
      - "/templates/container.gitlab-ci.yml"

variables:
  GITLABFILET_IMAGE: git-registry.hack-hro.de:443/kmohrf/docker-recipes/debbuild-python-webdev:bookworm

default:
  tags:
    - fast-io
    - fast-network
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .npm/

stages:
  - test
  - build
  - deploy

.js-tests:
  stage: test
  image: node:lts-alpine
  before_script:
    - ADBLOCK=true npm ci --cache .npm --prefer-offline

lint::js:
  extends: .js-tests
  script:
    - npm run lint

test::js:
  extends: .js-tests
  script:
    - npm run test

deploy::container-image:
  variables:
    KANIKO_ARGS: --target production

test::python:
  services:
    - postgis/postgis:15-3.4-alpine
  variables:
    TOX_SKIP_ENV: lint-*
    POSTGRES_DB: turtlemail
    POSTGRES_USER: turtlemail
    POSTGRES_PASSWORD: "turtlemail"
    DATABASE_URL: "postgres://$POSTGRES_USER:$POSTGRES_PASSWORD@postgis-postgis/$POSTGRES_DB"
    TOX_TESTENV_PASSENV: DATABASE_URL
  before_script:
    - apt update -y
    - apt install -y binutils libproj-dev gdal-bin

lint::python:
  before_script:
    - apt update -y
    # Needed to run the "check-migrations" pre-commit hook
    - apt install -y binutils libproj-dev gdal-bin
